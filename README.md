# –ú–∞–∫–µ—Ç 3-–Ω–æ–¥–æ–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL 16 —Å Logical Replication

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø 3-–Ω–æ–¥–æ–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ PostgreSQL 16, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–≥–æ **logical replication** –≤ —Ç–æ–ø–æ–ª–æ–≥–∏–∏ "–∫–∞–∂–¥—ã–π-–∫-–∫–∞–∂–¥–æ–º—É" (full mesh). –ö–∞–∂–¥—ã–π —É–∑–µ–ª –ø—É–±–ª–∏–∫—É–µ—Ç —Å–≤–æ–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö —É–∑–ª–æ–≤.

### üéØ –ß—Ç–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ

- **3 Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞** (`shard0`, `shard1`, `shard2`) –Ω–∞ –ø–æ—Ä—Ç–∞—Ö **5433-5435**
- **–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞** `public.users` –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ —Å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- **–ü–æ–ª–Ω—ã–π mesh**: –∫–∞–∂–¥—ã–π —É–∑–µ–ª –ø—É–±–ª–∏–∫—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–≤–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –ª–∞–≥–æ–≤

### üö´ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- ‚ùå –ë–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π —Ç–∞–±–ª–∏—Ü
- ‚ùå –ë–µ–∑ Row Level Security (RLS)
- ‚ùå –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (pglogical, BDR)
- ‚ùå –ë–µ–∑ sequence-—à–∞—Ä–¥–∏–Ω–≥–∞

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã
git clone <your-repo>
cd <repo>

# –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
chmod +x *.sh
```

### 2. –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose up -d

# –î–æ–∂–¥–∏—Ç–µ—Å—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å)
docker-compose ps
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
./setup-replication.sh

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ fish shell –∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã:
bash setup-replication.sh
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ª—é–±–æ–º —É–∑–ª–µ
./check_lr.sh localhost 5433
./check_lr.sh localhost 5434
./check_lr.sh localhost 5435
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

–í—Å–µ —É–∑–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `public.users`:

```sql
CREATE TABLE public.users (
    user_id    BIGINT       NOT NULL,
    shard_id   SMALLINT     NOT NULL CHECK (shard_id BETWEEN 0 AND 2),
    email      TEXT         NOT NULL,
    created_at TIMESTAMPTZ  NOT NULL DEFAULT now(),
    PRIMARY KEY (user_id)
);

-- REPLICA IDENTITY FULL –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
ALTER TABLE public.users REPLICA IDENTITY FULL;
```

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è

### –¢–æ–ø–æ–ª–æ–≥–∏—è

```
shard0 (5433) ‚Üê‚Üí shard1 (5434) ‚Üê‚Üí shard2 (5435)
    ‚Üï              ‚Üï              ‚Üï
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—É–±–ª–∏–∫–∞—Ü–∏–∏

–ö–∞–∂–¥—ã–π —É–∑–µ–ª —Å–æ–∑–¥–∞—ë—Ç –æ–¥–Ω—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é:
- `shard0`: `pub_shard_0`
- `shard1`: `pub_shard_1`  
- `shard2`: `pub_shard_2`

### –ü–æ–¥–ø–∏—Å–∫–∏

–ö–∞–∂–¥—ã–π —É–∑–µ–ª –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –¥–≤–∞ –¥—Ä—É–≥–∏—Ö:
- `shard0`: `sub_from_shard_1`, `sub_from_shard_2`
- `shard1`: `sub_from_shard_0`, `sub_from_shard_2`
- `shard2`: `sub_from_shard_0`, `sub_from_shard_1`

**–í–∞–∂–Ω–æ**: 
- –ü–æ–¥–ø–∏—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `copy_data = false`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∫–ª—é—á–µ–π –ø—Ä–∏ –Ω–∞—á–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
- –°–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏–º–µ—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `sub_from_shard_X_to_Y` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

### –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ shard0 –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
psql -h localhost -p 5433 -U replicator -d app

INSERT INTO public.users (user_id, shard_id, email) 
VALUES (123456789, 0, 'test@shard0.com');
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–∞ shard1
psql -h localhost -p 5434 -U replicator -d app

SELECT * FROM public.users WHERE user_id = 123456789;

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ shard2
psql -h localhost -p 5435 -U replicator -d app

SELECT * FROM public.users WHERE user_id = 123456789;
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```bash
# –û–±–Ω–æ–≤–∏—Ç–µ –∑–∞–ø–∏—Å—å –Ω–∞ shard0
psql -h localhost -p 5433 -U replicator -d app

UPDATE public.users 
SET email = 'updated@shard0.com' 
WHERE user_id = 123456789;

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–ª–∏—Å—å
psql -h localhost -p 5434 -U replicator -d app

SELECT * FROM public.users WHERE user_id = 123456789;
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°–∫—Ä–∏–ø—Ç check_lr.sh

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞
./check_lr.sh localhost 5433

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ö–æ—Å—Ç–∞ –∏ –ø–æ—Ä—Ç–∞
./check_lr.sh shard1 5434

# –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
./check_lr.sh --help
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∫—Ä–∏–ø—Ç

- ‚úÖ **–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–æ–∫**: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `running`
- ‚úÖ **–õ–∞–≥ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < 10 MB
- ‚úÖ **–û—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**: –¥–æ–ª–∂–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
- ‚úÖ **–°–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã

### –í—ã—Ö–æ–¥–Ω—ã–µ –∫–æ–¥—ã

- `0` - –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- `1` - –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏–ª–∏ –≤—ã—Å–æ–∫–∏–π –ª–∞–≥
- `2` - –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–º

### –û—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose stop

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å —Ç–æ–º–∞–º–∏
docker-compose down -v
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose restart

# –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ–º
docker-compose down
docker-compose up -d
```

### –õ–æ–≥–∏

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose logs

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–∑–ª–∞
docker-compose logs shard0
docker-compose logs shard1
docker-compose logs shard2

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker-compose logs -f
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### Docker Compose

–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã PostgreSQL:
- `wal_level=logical` - –≤–∫–ª—é—á–µ–Ω–∏–µ logical replication
- `max_wal_senders=10` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ WAL –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π
- `max_replication_slots=10` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
- `shared_buffers=256MB` - —Ä–∞–∑–º–µ—Ä —Ä–∞–∑–¥–µ–ª—è–µ–º—ã—Ö –±—É—Ñ–µ—Ä–æ–≤
- `max_worker_processes=10` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- `max_logical_replication_workers=4` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤

### –ü–æ—Ä—Ç—ã

- `shard0`: 5433 ‚Üí 5432 (localhost:5433)
- `shard1`: 5434 ‚Üí 5432 (localhost:5434)
- `shard2`: 5435 ‚Üí 5432 (localhost:5435)

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|----------|---------|
| **–ü–æ–¥–ø–∏—Å–∫–∞ "failed"** | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `sync_error` –≤ `check_lr.sh`, —á–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Å–µ—Ç–µ–≤–æ–π —Ç–∞–π–º–∞—É—Ç |
| **–í—ã—Å–æ–∫–∏–π –ª–∞–≥** | –£–≤–µ–ª–∏—á—å—Ç–µ `max_worker_processes` –∏ `max_logical_replication_workers` |
| **–ö–æ–Ω—Ñ–ª–∏–∫—Ç duplicate key** | –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∏—à–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å–≤–æ–∏–º `shard_id` |
| **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç** | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ—Ä—Ç—ã 5433-5435 —Å–≤–æ–±–æ–¥–Ω—ã |
| **–û—à–∏–±–∫–∞ "unbound variable"** | –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ bash –≤–º–µ—Å—Ç–æ fish: `bash setup-replication.sh` |
| **–ö–æ–º–∞–Ω–¥—ã –∑–∞–≤–∏—Å–∞—é—Ç** | –ò–∑–±–µ–≥–∞–π—Ç–µ —Ü–∏–∫–ª–æ–≤ –≤ fish shell, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–∞–Ω–¥—ã |

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
docker network ls
docker network inspect postgres-cluster

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
docker exec -it shard0 bash
```

### –°–±—Ä–æ—Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä
docker-compose down -v

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
docker-compose up -d

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é
./setup-replication.sh
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
.
‚îú‚îÄ‚îÄ docker-compose.yml          # –û–ø–∏—Å–∞–Ω–∏–µ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ init-shard-0.sql           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è shard0
‚îú‚îÄ‚îÄ init-shard-1.sql           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è shard1
‚îú‚îÄ‚îÄ init-shard-2.sql           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è shard2
‚îú‚îÄ‚îÄ setup-replication.sh       # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ check_lr.sh                # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îî‚îÄ‚îÄ README.md                  # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üîÑ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `init-shard-*.sql` —Ñ–∞–π–ª—ã
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ `REFRESH PUBLICATION`

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `docker-compose.yml`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä: `docker-compose down && docker-compose up -d`
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ `./setup-replication.sh`

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [PostgreSQL Logical Replication](https://www.postgresql.org/docs/16/logical-replication.html)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [PostgreSQL Configuration](https://www.postgresql.org/docs/16/runtime-config.html)

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: `./check_lr.sh`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é Docker –∏ Docker Compose

## –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å–ª–µ DDL

### –í—Å—Ç–∞–≤–∫–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—è

–î–æ–ø—É—Å—Ç–∏–º –Ω–∞ `shard0` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∞
(–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏)
```sql
ALTER TABLE users ADD COLUMN t text ;
```
–∏ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å
```sql
INSERT INTO users (user_id, shard_id, email, t)
VALUES (1000001, 0, 'OlegDuletsky@Gmail.Com', 'OlegDuletsky@Gmail.Com');
```

—Ç–≥–¥–∞ –Ω–∞ shard1 –∏ shard2 –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è:
```shell
 ./check_lr.sh localhost 5434
[INFO] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ logical replication –¥–ª—è localhost:5434
[INFO] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∞–≥: 10 MB
[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ localhost:5434...

=== –°–¢–ê–¢–£–° –ü–û–î–ü–ò–°–û–ö –ù–ê localhost:5434 ===
–ü–æ–¥–ø–∏—Å–∫–∞                    | –°—Ç–∞—Ç—É—Å    | –õ–∞–≥        | PID
----------------------------|-----------|------------|--------
sub_from_shard_0             | ‚ùå stopped | ‚úÖ 0 B    | –Ω–µ—Ç
sub_from_shard_2             | ‚úÖ running | ‚úÖ 8 bytes | 3562

 ./check_lr.sh localhost 5435
[INFO] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ logical replication –¥–ª—è localhost:5435
[INFO] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∞–≥: 10 MB
[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ localhost:5435...

=== –°–¢–ê–¢–£–° –ü–û–î–ü–ò–°–û–ö –ù–ê localhost:5435 ===
–ü–æ–¥–ø–∏—Å–∫–∞                    | –°—Ç–∞—Ç—É—Å    | –õ–∞–≥        | PID
----------------------------|-----------|------------|--------
sub_from_shard_0             | ‚ùå stopped | ‚úÖ 0 B    | –Ω–µ—Ç
sub_from_shard_1             | ‚úÖ running | ‚úÖ -8 bytes | 3564
```

–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ shard1 –∏ shard2:
```sql
SELECT 
    subname,
    CASE 
        WHEN pid IS NOT NULL THEN 'running'
        ELSE 'stopped'
    END as status,
    COALESCE(pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), latest_end_lsn)), '0 B') as lag,
    COALESCE(last_msg_send_time::text, '') as last_msg_time,
    latest_end_lsn,
    pid
FROM pg_stat_subscription 
WHERE subname LIKE 'sub_from_shard_%'
ORDER BY subname;

    subname      | status  |   lag   |         last_msg_time         | latest_end_lsn | pid  
------------------+---------+---------+-------------------------------+----------------+------
 sub_from_shard_0 | stopped | 0 B     |                               |                |     
 sub_from_shard_2 | running | 8 bytes | 2025-08-18 19:38:52.154824+00 | 0/1975150      | 3562
```

–≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ shard1 –∏ shard2:
```sql
ALTER TABLE users ADD COLUMN t text ;
```

–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ shard1 –∏ shard2:
```sql
ALTER SUBSCRIPTION sub_from_shard_0 REFRESH PUBLICATION;
```

–ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å—ã –ø–æ–¥–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏:
```shell
ÓÇ∞  ./check_lr.sh localhost 5434
[INFO] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ logical replication –¥–ª—è localhost:5434
[INFO] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∞–≥: 10 MB
[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ localhost:5434...

=== –°–¢–ê–¢–£–° –ü–û–î–ü–ò–°–û–ö –ù–ê localhost:5434 ===
–ü–æ–¥–ø–∏—Å–∫–∞                    | –°—Ç–∞—Ç—É—Å    | –õ–∞–≥        | PID
----------------------------|-----------|------------|--------
sub_from_shard_0             | ‚úÖ running | ‚úÖ -288 bytes | 6311
sub_from_shard_2             | ‚úÖ running | ‚úÖ 8 bytes | 3562

[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏...
=== –°–õ–û–¢–´ –†–ï–ü–õ–ò–ö–ê–¶–ò–ò ===
–°–ª–æ—Ç                      | –¢–∏–ø      | –ê–∫—Ç–∏–≤–µ–Ω | Restart LSN | Confirmed Flush LSN
--------------------------|----------|---------|-------------|---------------------
sub_from_shard_1_to_0      | logical  | ‚úÖ     | 0/19794E8   | 0/1979520
sub_from_shard_1_to_2      | logical  | ‚úÖ     | 0/19794E8   | 0/1979520

[SUCCESS] –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ª–∞–≥ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã (< 10 MB)

ÓÇ∞ ./check_lr.sh localhost 5435
[INFO] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ logical replication –¥–ª—è localhost:5435
[INFO] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∞–≥: 10 MB
[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ localhost:5435...

=== –°–¢–ê–¢–£–° –ü–û–î–ü–ò–°–û–ö –ù–ê localhost:5435 ===
–ü–æ–¥–ø–∏—Å–∫–∞                    | –°—Ç–∞—Ç—É—Å    | –õ–∞–≥        | PID
----------------------------|-----------|------------|--------
sub_from_shard_0             | ‚úÖ running | ‚úÖ -296 bytes | 6311
sub_from_shard_1             | ‚úÖ running | ‚úÖ -8 bytes | 3564

[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏...
=== –°–õ–û–¢–´ –†–ï–ü–õ–ò–ö–ê–¶–ò–ò ===
–°–ª–æ—Ç                      | –¢–∏–ø      | –ê–∫—Ç–∏–≤–µ–Ω | Restart LSN | Confirmed Flush LSN
--------------------------|----------|---------|-------------|---------------------
sub_from_shard_2_to_0      | logical  | ‚úÖ     | 0/19794E0   | 0/1979518
sub_from_shard_2_to_1      | logical  | ‚úÖ     | 0/19794E0   | 0/1979518

[SUCCESS] –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ª–∞–≥ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã (< 10 MB)
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

–ù–∞ shard0:
```sql
CREATE TABLE t1 (t1 BIGSERIAL PRIMARY KEY);
INSERT INTO t1 DEFAULT VALUES;

ALTER PUBLICATION pub_shard_0  ADD TABLE t1;
```

–≤—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ shard1 –∏ shard2:
```sql
CREATE TABLE t1 (t1 BIGSERIAL PRIMARY KEY);
```

–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ shard1 –∏ shard2:
```sql
ALTER SUBSCRIPTION sub_from_shard_0 REFRESH PUBLICATION;
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã:
```shell
 ./check_lr.sh localhost 5434
[INFO] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ logical replication –¥–ª—è localhost:5434
[INFO] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∞–≥: 10 MB
[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ localhost:5434...

=== –°–¢–ê–¢–£–° –ü–û–î–ü–ò–°–û–ö –ù–ê localhost:5434 ===
–ü–æ–¥–ø–∏—Å–∫–∞                    | –°—Ç–∞—Ç—É—Å    | –õ–∞–≥        | PID
----------------------------|-----------|------------|--------
sub_from_shard_0             | ‚úÖ running | ‚úÖ -285 kB | 6311
sub_from_shard_2             | ‚úÖ running | ‚úÖ 8 bytes | 3562

[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏...
=== –°–õ–û–¢–´ –†–ï–ü–õ–ò–ö–ê–¶–ò–ò ===
–°–ª–æ—Ç                      | –¢–∏–ø      | –ê–∫—Ç–∏–≤–µ–Ω | Restart LSN | Confirmed Flush LSN
--------------------------|----------|---------|-------------|---------------------
sub_from_shard_1_to_0      | logical  | ‚úÖ     | 0/19794E8   | 0/1979520
sub_from_shard_1_to_2      | logical  | ‚úÖ     | 0/19794E8   | 0/1979520

[SUCCESS] –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ª–∞–≥ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã (< 10 MB)
~/Sites/lr-cdc  cursor-init 22:00:18 ÓÇ∞ ./check_lr.sh localhost 5435
[INFO] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ logical replication –¥–ª—è localhost:5435
[INFO] –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–π –ª–∞–≥: 10 MB
[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ localhost:5435...

=== –°–¢–ê–¢–£–° –ü–û–î–ü–ò–°–û–ö –ù–ê localhost:5435 ===
–ü–æ–¥–ø–∏—Å–∫–∞                    | –°—Ç–∞—Ç—É—Å    | –õ–∞–≥        | PID
----------------------------|-----------|------------|--------
sub_from_shard_0             | ‚úÖ running | ‚úÖ -301 kB | 6311
sub_from_shard_1             | ‚úÖ running | ‚úÖ -8 bytes | 3564

[INFO] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏...
=== –°–õ–û–¢–´ –†–ï–ü–õ–ò–ö–ê–¶–ò–ò ===
–°–ª–æ—Ç                      | –¢–∏–ø      | –ê–∫—Ç–∏–≤–µ–Ω | Restart LSN | Confirmed Flush LSN
--------------------------|----------|---------|-------------|---------------------
sub_from_shard_2_to_0      | logical  | ‚úÖ     | 0/19794E0   | 0/1979518
sub_from_shard_2_to_1      | logical  | ‚úÖ     | 0/19794E0   | 0/1979518

[SUCCESS] –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ª–∞–≥ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã (< 10 MB)
```
